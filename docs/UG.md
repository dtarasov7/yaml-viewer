# Расширенная инструкция пользователя: YAML Viewer

## 📌 Обзор утилиты

**YAML Viewer** — консольная TUI-утилита для интерактивного просмотра больших YAML-файлов в виде иерархического дерева. Особенности:

- ✅ **Ленивая загрузка** — обрабатывает файлы до 10 ГБ без зависаний
- ✅ **Безопасность** — защита от YAML-bomb и других DoS-атак
- ✅ **Многодокументные файлы** — поддержка разделителей `---`
- ✅ **Поиск и фильтрация** — regex-поиск по полям и значениям
- ✅ **Режим переноса строк** — удобный просмотр многострочных значений
- ✅ **Кэширование** — быстрая навигация по уже загруженным документам

---

## 🚀 Быстрый старт

### Установка зависимостей
Утилита не требует дополнительных пакетов — работает на стандартной библиотеке Python 3.6+.

```bash
# Проверка версии Python
python3 --version

# Запуск утилиты
python3 yaml-viewer.py config.yaml

# Просмотр нескольких файлов одновременно
python3 yaml-viewer.py file1.yaml file2.yaml file3.yaml
```

### Горячие клавиши (справка внизу экрана)

| Клавиша | Действие |
|---------|----------|
| `↑`/`↓` или `k`/`j` | Навигация по узлам |
| `←` | Свернуть текущий узел или перейти к родителю |
| `→` или `l` | Раскрыть текущий узел |
| `Enter` | Переключить состояние узла (раскрыть/свернуть) |
| `n`/`p` | Прокрутка на страницу вниз/вверх |
| `w` | Переключить режим переноса длинных строк |
| `a`/`z` | Раскрыть/свернуть текущий документ целиком |
| `A`/`Z` | Раскрыть/свернуть все загруженные документы |
| `s` | Поиск по текущему полю |
| `F` | Глобальный поиск по всем полям |
| `f` | Диалог фильтрации полей |
| `g` | Перейти к объекту по глобальному номеру |
| `Home`/`End` | Первый/последний документ |
| `PageUp`/`PageDown` | Следующий/предыдущий документ |
| `q`/`Q`/`Esc` | Выход из утилиты |

---

## 🔍 Сценарии использования (User Cases)

### 1. Анализ конфигурационных файлов Kubernetes

**Проблема:**  
Файлы манифестов Kubernetes часто содержат вложенные структуры и многострочные строки (например, ConfigMap с конфигурацией приложения).

**Решение:**
```bash
python3 yaml-viewer.py deployment.yaml
```

**Рекомендуемые действия:**
- Нажмите `w` для включения режима переноса строк — удобно просматривать многострочные значения в `data` ConfigMap
- Используйте `s` на поле `image`, чтобы найти все образы контейнеров в файле
- Нажмите `a` на корневом узле документа, чтобы раскрыть всю структуру развертывания

**Пример фильтрации:**
```
Нажмите 'f' → выберите поля: 'image', 'replicas', 'port' → Enter
```
Теперь в списке отображаются только ключевые параметры развертывания.

---

### 2. Отладка больших конфигов (100+ МБ)

**Проблема:**  
Стандартные редакторы (vim, nano) зависают при открытии больших файлов.

**Решение:**
```bash
python3 yaml-viewer.py huge-config.yaml
```

**Особенности работы:**
- Утилита загружает только первые 20 документов (настраивается через `PRELOAD_OBJECTS`)
- При прокрутке к концу списка автоматически подгружаются следующие документы
- Для перехода к конкретному документу используйте `g` → введите номер (например, `1500`)

**Совет:**  
Если нужно быстро найти ошибку в конце файла:
```
Нажмите 'End' → дождитесь загрузки последних документов → ищите узлы с красной подсветкой (ошибки)
```

---

### 3. Сравнение конфигураций нескольких окружений

**Проблема:**  
Нужно сравнить `dev.yaml`, `staging.yaml`, `prod.yaml` на различия в настройках.

**Решение:**
```bash
python3 yaml-viewer.py dev.yaml staging.yaml prod.yaml
```

**Как работать:**
1. В заголовке отображается `[0]`, `[1]`, `[2]` — глобальные индексы документов
2. Нажмите `PageDown`/`PageUp` для быстрого перехода между файлами
3. Используйте фильтрацию (`f`) для выбора ключевых полей (например, `database.host`, `api.timeout`)
4. Запомните значения в каждом файле для сравнения

**Пример:**  
После фильтрации по полю `timeout` вы увидите только строки вида:
```
[0] timeout: 30
[1] timeout: 60
[2] timeout: 120
```

---

### 4. Поиск уязвимостей в конфигурациях

**Проблема:**  
Нужно найти все места, где используются небезопасные настройки (например, `insecure: true`).

**Решение:**
```bash
python3 yaml-viewer.py *.yaml
```

**Поиск:**
1. Нажмите `F` (глобальный поиск)
2. Введите регулярное выражение: `insecure.*true|debug.*true|password`
3. Утилита найдет все совпадения и применит фильтр по соответствующим полям
4. Результаты отобразятся с желтой подсветкой в статусной строке: `Результатов: 15 (1)`

**Навигация по результатам:**
- После поиска курсор автоматически перейдет к первому результату
- Нажимайте `n`/`p` для перехода между результатами (реализовано через внутреннюю логику поиска)

---

### 5. Работа с многострочными строками (блоковые скаляры)

**Проблема:**  
В YAML часто используются блоковые скаляры (`|`, `>`) для хранения конфигов, скриптов, сертификатов.

**Пример структуры:**
```yaml
config:
  nginx.conf: |
    server {
      listen 80;
      server_name example.com;
      ...
    }
  startup-script: >
    echo "Starting service";
    systemctl start myapp;
```

**Как просматривать:**
1. Перейдите к узлу с многострочным значением
2. Нажмите `Enter` для просмотра полного содержимого в отдельном окне
3. В режиме просмотра:
   - `↑`/`↓` — вертикальная прокрутка
   - `←`/`→` — горизонтальная прокрутка (если отключен wrap)
   - `w` — переключить перенос строк
   - `q`/`Esc` — вернуться в дерево

---

### 6. Анализ ошибок парсинга

**Проблема:**  
YAML-файл содержит синтаксические ошибки, стандартные парсеры выдают непонятные сообщения.

**Решение:**
```bash
python3 yaml-viewer.py broken.yaml
```

**Особенности:**
- Утилита покажет ошибку в красном цвете с диагностикой:
  ```
  [0] _error: "Ошибка парсинга YAML: Некорректный отступ элемента списка в строке 42"
  ```
- В лог-файл `yaml-viewer.log` запишется полный стек вызовов для отладки
- Можно просмотреть "сырой" текст ошибочного документа через режим просмотра значения (`Enter` на узле `_error`)

---

## ⚙️ Расширенные возможности

### Фильтрация полей
1. Нажмите `f`
2. Стрелками выбирайте поля
3. Пробелом включайте/выключайте отображение
4. `Enter` — применить фильтр

**Полезно для:**
- Фокусировки на ключевых параметрах в сложных структурах
- Сравнения однотипных полей в разных документах
- Исключения шумовых данных (например, `metadata`, `labels`)

### Поиск по регулярным выражениям
Поддерживаемые операции:
- Простой поиск: `timeout`
- Регистронезависимый: `TIMEOUT` найдет `timeout`
- Regex: `port: [3-9]\d{3}` найдет порты 3000-9999
- Таймаут защиты: сложные regex автоматически обрезаются через 2 секунды

### Работа с очень большими файлами (>1 ГБ)
- Утилита загружает документы порциями по 5 штук (`LOAD_BATCH_SIZE`)
- Для перехода к конкретному документу используйте `g` вместо прокрутки
- Чтобы загрузить все документы: нажмите `End`, затем `Home` несколько раз
- При нехватке памяти утилита автоматически сбросит кэш старых документов

---

## 🔒 Безопасность

Утилита включает многоуровневую защиту:

| Угроза | Защита |
|--------|--------|
| YAML-bomb (глубокая вложенность) | Лимит 100 уровней (`MAX_YAML_DEPTH`) |
| Billion laughs attack | Лимит 100 тыс. ключей на объект (`MAX_OBJECT_KEYS`) |
| Длинные строки | Обрезка до 10 МБ (`MAX_STRING_LENGTH`) |
| Большие числа | Лимит 4300 цифр (`MAX_NUMBER_DIGITS`) |
| ReDoS | Таймаут 2 сек на regex-операции |
| Чтение системных файлов | Блокировка `/dev/`, `/proc/`, `/sys/` |
| Огромные файлы | Лимит 10 ГБ (`MAX_FILE_SIZE`) |

При обнаружении угрозы утилита:
1. Прекращает обработку опасного документа
2. Заменяет его объектом с полем `_error`
3. Записывает детали в `yaml-viewer.log`
4. Продолжает работу с остальными документами

---

## 💡 Советы и лайфхаки

1. **Быстрый переход к ошибкам:**  
   После загрузки файла нажмите `/` (в разработке) или визуально ищите красные строки с `_error`.

2. **Сохранение позиции:**  
   Перед выходом запомните глобальный индекс документа из заголовка (`[142]`) — при повторном запуске перейдите к нему через `g`.

3. **Работа в узком терминале:**  
   При ширине < 80 символов включите wrap-режим (`w`) для корректного отображения.

4. **Поиск по значению без указания поля:**  
   Используйте глобальный поиск (`F`) с паттерном `: "значение"` для поиска точных совпадений.

5. **Экспорт найденных значений:**  
   Результаты поиска можно скопировать через режим просмотра значения (`Enter` на результате → копирование из терминала).

---

## ❓ Частые вопросы

**Q: Почему некоторые документы не загружаются автоматически?**  
A: Для экономии памяти утилита использует ленивую загрузку. Документы подгружаются при прокрутке к ним или через команду `g`.

**Q: Как отключить цветовую подсветку?**  
A: Цвета управляются терминалом. Запустите с `TERM=xterm-mono python3 yaml-viewer.py file.yaml`.

**Q: Поддерживает ли утилита теги YAML (например, `!!str`)?**  
A: Нет, встроенный парсер игнорирует теги. Для сложных сценариев рекомендуется использовать официальный парсер PyYAML отдельно.

**Q: Где найти лог ошибок?**  
A: Лог записывается в `yaml-viewer.log` в текущей директории. Содержит timestamp, контекст ошибки и полный стек вызовов.

---

## 📜 Лицензия и поддержка

Утилита распространяется бесплатно под лицензией MIT.  
Автор: Tarasov Dmitry  
Версия: 1.0.0

**Сообщить об ошибке:**  
1. Проверьте `yaml-viewer.log` на наличие записей
2. Создайте issue с приложением:
   - Версия ОС и Python
   - Пример проблемного YAML (без конфиденциальных данных)
   - Содержимое `yaml-viewer.log`

> 💡 **Важно:** Утилита предназначена для просмотра, а не редактирования YAML. Для модификации файлов используйте специализированные инструменты (yq, sed, редакторы).
